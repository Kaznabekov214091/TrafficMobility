CREATE OR ALTER PROCEDURE InsertFactAir
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @LastAirDate DATE = (
        SELECT dateValue 
        FROM Checkpoints 
        WHERE TableName = 'air_quality'
    );

    INSERT INTO FactAir (DateKey, BoroughKey, AvgPM25)
    SELECT 
        CAST(FORMAT(a.timestamp_local,'yyyyMMdd') AS INT) AS DateKey,
        z.BoroughID,
        AVG(CAST(a.pm25 AS DECIMAL(10,4))) AS AvgPM25

    FROM Silver.silver.air_quality a
    LEFT JOIN DimDate d
        ON CAST(a.timestamp_local AS DATE) = d.DateValue
    LEFT JOIN DimZone z
        ON a.LocationID = z.LocationID
    LEFT JOIN FactAir f
        ON f.DateKey = CAST(FORMAT(a.timestamp_local,'yyyyMMdd') AS INT)
        AND f.BoroughKey = z.BoroughID
    WHERE f.DateKey IS NULL
      AND CAST(a.timestamp_local AS DATE) > @LastAirDate 
    GROUP BY CAST(FORMAT(a.timestamp_local,'yyyyMMdd') AS INT), z.BoroughID;
END;
GO
